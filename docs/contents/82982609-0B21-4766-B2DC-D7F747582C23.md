# [C/C++] #defineで定義していない識別子を全部大文字で書くことの危うさ

`size_t const NAME_LENGTH = 0x100;`みたいに`#define`で定義していない識別を全部大文字で危険ですよというお話。[プリプロセッサ-Wikipedia](https://ja.wikipedia.org/wiki/%E3%83%97%E3%83%AA%E3%83%97%E3%83%AD%E3%82%BB%E3%83%83%E3%82%B5)にも書いてある内容なんですが、Wikipediaの方は消す人が出てきそうなのでこちらにも残そうと思います。

## 結論

なぜ危険なのか？結論を言うと`#define`で定義した識別子が、`const`や`enum`で定義した識別子を上書きしてしまうからです。C++の作者が[#define以外は絶対に大文字を使うな](http://www.libjingu.jp/trans/bs_faq2-j.html#Hungarian)と言っているように「#define」で定義した識別子以外の名前を全部大文字で定義するのは止めましょう。

## 問題例

```C++
#define NAME_LENGTH 0x200
size_t const NAME_LENGTH = 0x100;
char name[NAME_LENGTH] = "";  // 0x200じゃなく0x100で確保される
```

こちら、そんな間違いすぐ気づくでしょと思うかもしれませんが現実ではそうそう気づくことはありません。
それは、```#include```で定義が隠れてしまっている上に警告が出ないからです。

```C++
// source0.cpp
#include "define0.h" // #define NAME_LENGTH 0x200
#include "define1.h" // size_t const NAME_LENGTH = 0x100;

namespace
{
    char name[NAME_LENGTH] = "";  // 長さは 0x100
}
```

```C++
// source1.cpp
#include "define0.h"

namespace
{
    int name[NAME_LENGTH] = "";  // 長さは 0x100
}
```

果たして気づく自信はあるでしょうか？異常終了が発生するようになってから、こういうことがあるということを知っている人ならギリギリ原因にたどり着けるかもしれませんが、実際の開発では疑わしい定数が無数にあるわけですから膨大な時間を取られるでしょう。私も2度遭遇しましたが、この問題をしっている現場で気づけた人は私しかいませんでした。


## 異論

### そもそも衝突することなんてあるの？

大文字で書いていても少数で書いていれば中々遭遇しないでしょう。
問題が発生しやすいのは

1. libraryの実装者と使う側が別れている。
1. ２つの実行fileに別れているものを1つにした。

といった場合です。
1は特に依存しているlibraryを追加したり交換した場合に名前の上書きが発生します。
2は、古い方の実行fileでは`#define`で、新しい方の実行fileはこの際だから`const`にしておくかで実装されてしまっていた場合に発生します。


### 接頭辞や接尾辞がついているから心配しなくて良いんじゃない？

`#define MDX_NAME_LENGTH 0x200` のようにする方法ですが、ぶつかるときにはぶつかるのでアテになりません。特に上記の2の場合、2つの実行fileで同じ名前を使ってることが大半だと思います。
また、せっかく名前空間を使って短い名前で参照できるようにしていてもそれが無駄になってしまいます。

### Cの標準libraryだって小文字で`#define`してるでしょ

Cの標準libraryでも小文字で`#define`した識別子が残っていますが、こちらは「Code Craft ~エクセレントなコードを書くための実践的技法~」(p.570)にあるように歴史的な名残であるとか、次期の言語規格で[正式に予約語にしたい](https://www.open-std.org/jtc1/sc22/wg14/www/docs/n2392.pdf)けど、すぐ予約後にすると影響が大きすぎるので`#undef`できる識別子で様子見しとこうというものです。
安易に真似をして良いものではありません。


## 定数名を大文字で書くべきという誤解

Javaが定数名を全部大文字で書くようにした影響か、Rubyが全部大文字で書いた名前は変数ではなく定数名となるようにした影響か、2010年以降あたり定数名は全部大文字と書くものだと思ってる人が増えたように思います。じゃあわざわざなんで定数名と変数名を区別すべきなのか区別しないとなぜ困るのか感覚的な答え以外で説明できる人を見たことがありません。Smalltalkや.Net系言語なら定数に小文字が入りますがそれも説明できません。

## 関連記事

- [記事一覧](../index.md)
